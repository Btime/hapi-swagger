<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ hapiSwagger.info.title }}</title>
    <link rel="stylesheet" type="text/css" href="{{ hapiSwagger.swaggerUIPath }}swagger-ui.css" />
    <link rel="icon" type="image/png" href="{{ hapiSwagger.swaggerUIPath }}favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="{{ hapiSwagger.swaggerUIPath }}favicon-16x16.png" sizes="16x16" />
    <style>
      html {
        box-sizing: border-box;
        overflow: -moz-scrollbars-vertical;
        overflow-y: scroll;
      }

      *,
      *:before,
      *:after {
        box-sizing: inherit;
      }

      body {
        margin: 0;
        background: #fafafa;
      }
    </style>
  </head>

  <body>
    <div id="swagger-ui"></div>
    <script src="{{ hapiSwagger.swaggerUIPath }}swagger-ui-bundle.js"></script>
    <script src="{{ hapiSwagger.swaggerUIPath }}swagger-ui-standalone-preset.js"></script>
    <script src="{{ hapiSwagger.swaggerUIPath }}extend.js" type="text/javascript"></script>
    <script>

      var ACCESS_TOKENS_KEY = slugify(window.location.pathname) + "-hapi-swagger-auth";
      var ACCESS_TOKEN_QUERY_PARAM_NAME = 'access_token';

      function slugify(text) {
          return text.toString().toLowerCase()
            .replace(/\s+/g, '-')           // Replace spaces with -
            .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
            .replace(/--+/g, '-')           // Replace multiple - with single -
            .replace(/^-+/, '')             // Trim - from start of text
            .replace(/-+$/, '');            // Trim - from end of text
        }

      function onComplete() {
        const savedSchemas = localStorage.getItem(ACCESS_TOKENS_KEY);
        if(savedSchemas) {
          const schemas = JSON.parse(savedSchemas);
          schemas.forEach(function(auth) {
            const schema = auth.schema;
            const securityDefinitionName = auth.name;
            const name = schema.name;
            const type = schema.type;
            const value = auth.value;
            if (type === "basic" && name) {
              var username = value.username;
              var password = value.password;
              if (username && password) {
                ui.preauthorizeBasic(securityDefinitionName, username, password);
              }
            } else if (type === "apiKey" && name) {
              if (value) {
                debugger;
                ui.preauthorizeApiKey(securityDefinitionName, name, value);
              }
            }else {
              // ????
            }
          });
        }

      }

      function getUrlVars() {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
          hash = hashes[i].split('=');
          vars.push(hash[0]);
          vars[hash[0]] = hash[1];
        }
        return vars;
      }

      var url = window.location.search.match(/url=([^&]+)/);
      if (url && url.length > 1) {
          url = decodeURIComponent(url[1]);
      } else {
          url = "{{{hapiSwagger.jsonPath}}}";
      }

      function createSwaggerOptions() {
          // pull validatorUrl string or null form server
          var validatorUrl = null;
          {{#if hapiSwagger.validatorUrl}}
          validatorUrl: '{{hapiSwagger.validatorUrl}}';
          {{/if}}

          var accessToken = getUrlVars()[ACCESS_TOKEN_QUERY_PARAM_NAME];
          var swaggerOptions = {
            url: url + (accessToken ? (url.indexOf('?') < 0 ? '?' : '&') + ACCESS_TOKEN_QUERY_PARAM_NAME + '=' + accessToken : ''),
            validatorUrl: validatorUrl,
            dom_id: '#swagger-ui',
            deepLinking: true,
            presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
            plugins: [SwaggerUIBundle.plugins.DownloadUrl],
            layout: 'StandaloneLayout',
            filter: true,
            docExpansion: "{{hapiSwagger.expanded}}",
            tagsSorter: apisSorter.{{hapiSwagger.sortTags}},
            operationsSorter: operationsSorter.{{hapiSwagger.sortEndpoints}},
            onComplete: onComplete
          }

          return swaggerOptions;
      }

      function loadSwaggerUi() {

        var ui = SwaggerUIBundle(createSwaggerOptions());

        var _authorize = ui.authActions.authorize;
        // intercept the authorize token from UI
        ui.authActions.authorize = function (authorization) {
          _authorize(authorization)

          const keys = Object.keys(authorization);
          function reducer(accum, key) {
            const schema = authorization[key];
            accum.push(schema);
            return accum;
          }
          const schemas = keys.reduce(reducer, []);
          const tokens = JSON.stringify(schemas);

          localStorage.setItem(ACCESS_TOKENS_KEY, tokens);

        };

        var _logout = ui.authActions.logout;
        ui.authActions.logout = function (payload) {
          _logout(payload);
          window.localStorage.removeItem(ACCESS_TOKENS_KEY);
        };

        window.ui = ui;
      }

      window.addEventListener('load', loadSwaggerUi);
    </script>
  </body>
</html>
